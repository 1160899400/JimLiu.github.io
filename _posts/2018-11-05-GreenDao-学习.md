---
layout: post
title:  "AndroidDSL Gradel Plugin"
date:   2018-09-26
tags:
- Android
- Groovy
- Gradle
---

## GreenDao
---

### GreenDao简介
&emsp;&emsp;GreenDao主要是为了简化android客户端对SQLite数据库一系列操作，而对数据库的相关操作封装的一个ORM框架，底层是基于对SQLite的封装，对比其它框架，GreenDao拥有非常好的读写性能和缓存策略。  

### GreenDao简单使用
&emsp;&emsp;使用GreenDao创建数据库Schema、建表，并进行简单的增删改查的步骤依次如下**（3.x为例）**：  
&emsp;&emsp;首先创建一个entity实体：  
```Java
@Entity
public Class student{
	@Id(autoincrement = true)
	private long id;
    
	private String name;
	
	@Transient
	private int age;
}
```
&emsp;&emsp;然后编译，GreenDao就会自动识别带有`@Entity`注释的实体类，并为其重新生成实体类，生成的实体类代码如下：
```Java
@Entity
public class Student {
	/**
	 * @Id 标明该Field为主键，autoincrement属性代表是否自增
	*/ 
    @Id(autoincrement = true)
    public Long id;

	/**
	 * @NotNull 标明对应的数据库字段为NotNull
	 */
    @NotNull
    private String age;

    /**
     * @Transient 类似于transient关键字
     * 该变量不会被序列化，也意味着不会生成对应的数据库字段
     */
    @Transient
    private String info;

    @Generated(hash = 628442569)
    public Student(Long id, @NotNull String age) {
        this.id = id;
        this.age = age;
    }

    @Generated(hash = 1556870573)
    public Student() {
    }

    public Long getId() {
        return this.id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getAge() {
        return this.age;
    }

    public void setAge(String age) {
        this.age = age;
    }
}
```

&emsp;&emsp;可以看到生成的Entity会有一个默认的无参的Constructor和将所有不会被序列化的成员作为参数的Constructor。生成的每个Constructor都有一个@Generated(hash = xxxxxx)的注解，这里还不太清楚该注解的明确用处，推测是GreenDao用来进行缓存处理的。  

对于GreenDao中所有的注解及其作用，整理如下表：

| GreenDao Annotation |                            Usage                             |
| :------------------ | :----------------------------------------------------------: |
| @Entity             | 指明需要映射到数据库的实体类，nameInDb属性可以设置在数据库中的表名；indexes属性可以设置索引（多列）；createInDb设置是否在数据库中建表；schema设置该表对应的schema， |
| @Id                 | 指明当前实体对应的表的主键，通过autoincrement属性可以设置是否自增 |
|                     |                                                              |
|                     |                                                              |



### GeenDao3.x与2.x的主要区别
&emsp;&emsp;GreenDao3.x和2.x版本相比，增加了编译前自动生成类文件的功能，避免自行书写代码然后手动编译运行输出类文件。3.x中可以在gradle中配置数据库版本号、生成文件的路径、单元测试文件的路径等信息，project build时就能根据Entity实体自动生成类文件及注释，而GreenDao 2.x必须手动书写生成文件的代码并编译执行。   

&emsp;&emsp;GreenDao3.x中，还要在gradle中添加下面的dependency，这样在Sync Project时会下载一个gradle插件，用于生成类文件，添加的依赖如下。  

```basic
classpath 'org.greenrobot:greendao-gradle-plugin:3.2.2'
```

&emsp;&emsp;这个插件是通过扫描所有的带有`@Entity`注释的实体类，并读取gradle中的配置信息，调用DaoGenerator模块生成，后面会对其源码分析。



### GreenDao源码分析

&emsp;&emsp;GreenDao项目源码主要分为两个Module，DaoCore和DaoGenerator。   

&emsp;&emsp;首先介绍DaoGenerator模块，这个模块主要封装了自动生成java类文件的功能，这里自动生成类文件用到了FreeMarker模板引擎，简单的来讲，通过freemaker能根据.ftl 模板文件和自定义的变量来动态输出目标文件。 生成的**DaoMaster.java**、**DaoSession.java**以及带有`@Entity`注释的实体类对应的**xxxDao.java**，并根据情况判断是否重新生成实体类。  

&emsp;&emsp;顾名思义，DaoCore模块是GreenDao核心，包含了对Database的基本操作  ......(WAIT TO COMPLETE)。DaoCore分层如下：  



&emsp;&emsp;首先根据官方提供的GreenDao用例入手分析，官方的例子中，第一步是实例化`DaoMaster.DevOpenHelper`内部类对象，这个类的继承关系为`DaoMaster.DevOpenHelper`->`DaoMaster.OpenHelper`->`DatabaseOpenHelper`->`SQLiteOpenHelper`。`DevOpenHelper`主要重写了数据库的升级操作`onUpgrade()`，默认的升级操作为删除所有表并重新建立，在这里我们可以修改并自定义升级操作。`OpenHelper`中定义了建表和传入当前数据库版本的功能。`DatabaseOpenHelper`负责将SQLiteDatabase扩展成Database。 在生成的文件中，DaoMaster是数据库操作的入口，这里有  

&emsp;&emsp;在生成

#### GreenDao自动生成文件的原理




